{% extends "base.html" %}

{% block title %}Обробка актуалізації{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-arrow-clockwise"></i> Обробка актуалізації: {{ filename }}</h2>
                <a href="{{ url_for('main.file_manager') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Назад до файлів
                </a>
            </div>

            <!-- Progress Status -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Статус обробки актуалізації</h5>
                        </div>
                        <div class="card-body">
                            <div id="status-message" class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Ініціалізація процесу актуалізації...
                                </div>
                            </div>
                            
                            <div id="progress-section" style="display: none;">
                                <div class="progress mb-3">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <p id="progress-text" class="mb-0">Підготовка...</p>
                            </div>

                            <!-- Кнопка запуску обробки -->
                            <div id="start-section" style="display: none;">
                                <button id="start-processing" class="btn btn-success btn-lg">
                                    <i class="bi bi-play-circle"></i> Почати актуалізацію
                                </button>
                                <p class="text-muted mt-2">Натисніть кнопку, щоб почати обробку актуалізації зовнішнім скриптом</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-list-check"></i> Статистика</h6>
                        </div>
                        <div class="card-body">
                            <div id="stats">
                                <p class="mb-1"><strong>Загальних записів:</strong> <span id="total-lines">-</span></p>
                                <p class="mb-1"><strong>Валідних ЄДRПОУ:</strong> <span id="valid-count">-</span></p>
                                <p class="mb-1"><strong>Помилкових:</strong> <span id="error-count">-</span></p>
                                <p class="mb-0"><strong>Оновлено:</strong> <span id="updated-count">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Log -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-terminal"></i> Лог обробки</h6>
                        </div>
                        <div class="card-body">
                            <div id="log-container" class="border rounded p-3" 
                                 style="height: 300px; overflow-y: auto; background-color: var(--bs-dark); color: var(--bs-light);">
                                <div class="text-light mb-2">
                                    <i class="bi bi-info-circle"></i> Логи обробки актуалізації:
                                </div>
                                <div id="log-messages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card" id="results-card" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle-fill"></i> Актуалізація завершена
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="result-message" class="mb-3"></div>
                                    <div id="result-stats"></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('main.companies') }}" class="btn btn-success">
                                            <i class="bi bi-list-ul"></i> Переглянути компанії
                                        </a>
                                        <a href="{{ url_for('main.file_manager') }}" class="btn btn-outline-primary">
                                            <i class="bi bi-folder2-open"></i> Менеджер файлів
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filename = '{{ filename }}';
    const statusMessage = document.getElementById('status-message');
    const progressSection = document.getElementById('progress-section');
    const startSection = document.getElementById('start-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const totalLines = document.getElementById('total-lines');
    const validCount = document.getElementById('valid-count');
    const errorCount = document.getElementById('error-count');
    const updatedCount = document.getElementById('updated-count');
    const logMessages = document.getElementById('log-messages');
    const resultsCard = document.getElementById('results-card');
    const startProcessingBtn = document.getElementById('start-processing');

    function addLogMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const iconClass = type === 'error' ? 'bi-exclamation-triangle-fill text-danger' : 
                         type === 'success' ? 'bi-check-circle-fill text-success' : 
                         'bi-info-circle-fill text-info';
        
        const logEntry = document.createElement('div');
        logEntry.className = 'mb-1 small';
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> <i class="bi ${iconClass}"></i> ${message}`;
        
        logMessages.appendChild(logEntry);
        document.getElementById('log-container').scrollTop = document.getElementById('log-container').scrollHeight;
    }

    // Analyze file first
    addLogMessage('Аналіз файлу актуалізації...', 'info');
    
    fetch(`/api/actualize-csv/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusMessage.innerHTML = `
                    <div class="d-flex align-items-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Помилка:</strong> ${data.error}
                    </div>
                `;
                statusMessage.className = 'alert alert-danger';
                addLogMessage(`Помилка аналізу: ${data.error}`, 'error');
                return;
            }

            // Update stats
            totalLines.textContent = data.total_lines || 0;
            validCount.textContent = data.valid_edrpou_count || 0;
            errorCount.textContent = data.invalid_count || 0;

            // Show ready status
            statusMessage.innerHTML = `
                <div class="d-flex align-items-center text-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Готово:</strong> ${data.message}
                </div>
            `;
            statusMessage.className = 'alert alert-success';
            
            // Show start button
            startSection.style.display = 'block';
            
            addLogMessage(`Файл проаналізовано: ${data.total_lines} рядків`, 'success');
            addLogMessage(`Валідних ЄДRПОУ: ${data.valid_edrpou_count}`, 'info');
            addLogMessage(`Готово для актуалізації ${data.valid_edrpou_count} компаній`, 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            statusMessage.innerHTML = `
                <div class="d-flex align-items-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Помилка мережі:</strong> ${error.message}
                </div>
            `;
            statusMessage.className = 'alert alert-danger';
            addLogMessage(`Помилка мережі: ${error.message}`, 'error');
        });

    // Start processing button handler
    startProcessingBtn.addEventListener('click', function() {
        startProcessingBtn.disabled = true;
        startSection.style.display = 'none';
        progressSection.style.display = 'block';
        
        statusMessage.innerHTML = `
            <div class="d-flex align-items-center text-warning">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <strong>Обробка:</strong> Виконується актуалізація компаній...
            </div>
        `;
        statusMessage.className = 'alert alert-warning';
        
        progressBar.style.width = '50%';
        progressText.textContent = 'Обробка актуалізації...';
        
        addLogMessage('Початок обробки актуалізації зовнішнім скриптом...', 'info');
        addLogMessage('Це може зайняти кілька хвилин...', 'info');
        
        // Start actual processing
        fetch(`/api/actualize-start/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    addLogMessage('Обробка запущена у фоновому режимі', 'info');
                    addLogMessage('Перевіряємо статус...', 'info');
                    
                    // Почати перевірку статусу
                    checkProcessingStatus();
                } else if (data.status === 'error') {
                    // Success
                    statusMessage.innerHTML = `
                        <div class="d-flex align-items-center text-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Завершено:</strong> ${data.message}
                        </div>
                    `;
                    statusMessage.className = 'alert alert-success';
                    
                    progressBar.style.width = '100%';
                    progressBar.className = 'progress-bar bg-success';
                    progressText.textContent = 'Актуалізація завершена успішно!';
                    
                    updatedCount.textContent = data.updated_count || 0;
                    
                    // Show results
                    document.getElementById('result-message').innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle-fill"></i> ${data.message}</h5>
                        </div>
                    `;
                    
                    document.getElementById('result-stats').innerHTML = `
                        <p><strong>Оновлено компаній:</strong> ${data.updated_count}</p>
                        <p><strong>Результуючий файл:</strong> ${data.result_file}</p>
                    `;
                    
                    resultsCard.style.display = 'block';
                    
                    addLogMessage(`Актуалізація завершена успішно!`, 'success');
                    addLogMessage(`Оновлено ${data.updated_count} компаній`, 'success');
                    addLogMessage(`Результат збережено в файл: ${data.result_file}`, 'info');
                    
                    // Show stdout if available
                    if (data.stdout) {
                        const stdout_lines = data.stdout.split('\n');
                        stdout_lines.forEach(line => {
                            if (line.trim()) {
                                addLogMessage(line.trim(), 'info');
                            }
                        });
                    }
                    
                } else {
                    // Error
                    statusMessage.innerHTML = `
                        <div class="d-flex align-items-center text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Помилка:</strong> ${data.error}
                        </div>
                    `;
                    statusMessage.className = 'alert alert-danger';
                    
                    progressBar.className = 'progress-bar bg-danger';
                    progressText.textContent = 'Помилка при обробці актуалізації';
                    
                    addLogMessage(`Помилка запуску: ${data.error}`, 'error');
                    
                    startProcessingBtn.disabled = false;
                    startSection.style.display = 'block';
                    progressSection.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Start error:', error);
                statusMessage.innerHTML = `
                    <div class="d-flex align-items-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Помилка запуску:</strong> ${error.message}
                    </div>
                `;
                statusMessage.className = 'alert alert-danger';
                
                progressBar.className = 'progress-bar bg-danger';
                progressText.textContent = 'Помилка запуску';
                
                addLogMessage(`Помилка запуску: ${error.message}`, 'error');
                
                startProcessingBtn.disabled = false;
                startSection.style.display = 'block';
                progressSection.style.display = 'none';
            });
    });

    // Function to check processing status
    function checkProcessingStatus() {
        fetch(`/api/actualize-status/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing') {
                    addLogMessage('Обробка триває...', 'info');
                    progressBar.style.width = '75%';
                    progressText.textContent = 'Обробка актуалізації...';
                    
                    // Перевірити знову через 5 секунд
                    setTimeout(checkProcessingStatus, 5000);
                    
                } else if (data.status === 'completed') {
                    // Success
                    statusMessage.innerHTML = `
                        <div class="d-flex align-items-center text-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Завершено:</strong> ${data.message}
                        </div>
                    `;
                    statusMessage.className = 'alert alert-success';
                    
                    progressBar.style.width = '100%';
                    progressBar.className = 'progress-bar bg-success';
                    progressText.textContent = 'Актуалізація завершена успішно!';
                    
                    updatedCount.textContent = data.updated_count || 0;
                    
                    // Show results
                    document.getElementById('result-message').innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="bi bi-check-circle-fill"></i> ${data.message}</h5>
                        </div>
                    `;
                    
                    document.getElementById('result-stats').innerHTML = `
                        <p><strong>Оновлено компаній:</strong> ${data.updated_count}</p>
                        <p><strong>Результуючий файл:</strong> ${data.result_file}</p>
                    `;
                    
                    resultsCard.style.display = 'block';
                    
                    addLogMessage(`Актуалізація завершена успішно!`, 'success');
                    addLogMessage(`Оновлено ${data.updated_count} компаній`, 'success');
                    addLogMessage(`Результат збережено в файл: ${data.result_file}`, 'info');
                    
                } else if (data.status === 'error') {
                    // Error
                    statusMessage.innerHTML = `
                        <div class="d-flex align-items-center text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Помилка:</strong> ${data.error}
                        </div>
                    `;
                    statusMessage.className = 'alert alert-danger';
                    
                    progressBar.className = 'progress-bar bg-danger';
                    progressText.textContent = 'Помилка при обробці';
                    
                    addLogMessage(`Помилка обробки: ${data.error}`, 'error');
                    
                    startProcessingBtn.disabled = false;
                    startSection.style.display = 'block';
                    progressSection.style.display = 'none';
                    
                } else {
                    // Перевірити знову через 5 секунд
                    setTimeout(checkProcessingStatus, 5000);
                }
            })
            .catch(error => {
                console.error('Status check error:', error);
                addLogMessage(`Помилка перевірки статусу: ${error.message}`, 'error');
                
                // Спробувати знову через 5 секунд
                setTimeout(checkProcessingStatus, 5000);
            });
    }
});
</script>
{% endblock %}