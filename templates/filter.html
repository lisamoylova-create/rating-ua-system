{% extends "base.html" %}

{% block title %}Відбір компаній для рейтингу - Рейтинг.UA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-funnel"></i> Відбір компаній для рейтингу</h1>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Параметри фільтрації</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-filter-circle"></i> Етап 1: Основні критерії відбору</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="min_employees" class="form-label">Мінімальна кількість працівників</label>
                                    <input type="number" class="form-control" id="min_employees" name="min_employees" 
                                           value="0" min="0" step="1">
                                    <div class="form-text">Залишати лише компанії з кількістю працівників ≥ зазначеного значення</div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="min_revenue" class="form-label">Мінімальний дохід (грн)</label>
                                    <input type="number" class="form-control" id="min_revenue" name="min_revenue" 
                                           value="0" min="0" step="0.01">
                                    <div class="form-text">Залишати лише компанії з доходом ≥ зазначеного значення</div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="min_profit" class="form-label">Мінімальний прибуток (грн)</label>
                                    <input type="number" class="form-control" id="min_profit" name="min_profit" 
                                           value="" step="0.01">
                                    <div class="form-text">Залишати лише компанії з прибутком ≥ зазначеного значення (необов'язково)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-funnel"></i> Етап 2: Додаткові фільтри</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="region_filter" class="form-label">Регіони</label>
                                    <select class="form-select" id="region_filter" name="region_filter" multiple size="4">
                                        <!-- Options will be loaded via JavaScript -->
                                    </select>
                                    <div class="form-text">Утримуйте Ctrl для вибору кількох регіонів</div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="kved_filter" class="form-label">КВЕД коди</label>
                                    <select class="form-select" id="kved_filter" name="kved_filter" multiple size="4">
                                        <!-- Options will be loaded via JavaScript -->
                                    </select>
                                    <div class="form-text">Утримуйте Ctrl для вибору кількох КВЕД кодів</div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="size_filter" class="form-label">Розміри компаній</label>
                                    <select class="form-select" id="size_filter" name="size_filter" multiple size="4">
                                        <!-- Options will be loaded via JavaScript -->
                                    </select>
                                    <div class="form-text">Утримуйте Ctrl для вибору кількох розмірів</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selection Progress Panel -->
                    <div class="card mb-4" id="selection-progress" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-hourglass-split"></i> Процес відбору</h6>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" id="selection-progress-bar" style="width: 0%"></div>
                            </div>
                            <div id="selection-status" class="text-muted">
                                Початок відбору...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selection Results Panel -->
                    <div class="card mb-4" id="selection-results" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-check-circle-fill text-success"></i> Результати відбору</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle p-2 me-3">
                                            <i class="bi bi-building text-white"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0" id="selected-count">0</h5>
                                            <small class="text-muted">Компаній відібрано</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-circle p-2 me-3">
                                            <i class="bi bi-percent text-white"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0" id="selection-percentage">0%</h5>
                                            <small class="text-muted">Від загальної кількості</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    <span id="selection-criteria-display">Критерії не вибрано</span>
                                </small>
                            </div>
                            <div class="mt-3">
                                <a href="{{ url_for('main.ranking') }}" class="btn btn-success">
                                    <i class="bi bi-arrow-right"></i> Перейти до створення рейтингу
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Увага:</strong> Після застосування фільтрів створиться база відібраних компаній. 
                        Ця база буде використана для створення рейтингу на наступному етапі.
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="filter-submit">
                            <i class="bi bi-check-circle"></i> Застосувати фільтри та відібрати
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Як працює фільтрація</h6>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li><strong>Етап 1 - Основні критерії відбору:</strong>
                        <ul>
                            <li>Мінімальна кількість працівників</li>
                            <li>Мінімальний дохід</li>
                            <li>Мінімальний прибуток (опціонально)</li>
                        </ul>
                    </li>
                    
                    <li><strong>Етап 2 - Додаткові фільтри:</strong>
                        <ul>
                            <li>Фільтрація по регіонах</li>
                            <li>Фільтрація по КВЕД кодах</li>
                            <li>Фільтрація по розмірах компаній</li>
                            <li>Регіональний КВЕД фільтр (якщо увімкнено)</li>
                        </ul>
                    </li>
                    

                </ol>
                
                <div class="alert alert-success mt-3">
                    <small>
                        <i class="bi bi-arrow-right-circle"></i>
                        <strong>Послідовність:</strong> Кожен етап обробляє результати попереднього етапу, 
                        забезпечуючи точну фільтрацію та рейтинг.
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Статистика</h6>
            </div>
            <div class="card-body">
                <div id="stats-loading" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Завантаження...</span>
                    </div>
                    Завантаження статистики...
                </div>
                <div id="stats-content" style="display: none;">
                    <!-- Statistics will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Selection History -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Історія відборів</h6>
            </div>
            <div class="card-body">
                <div id="history-loading" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Завантаження...</span>
                    </div>
                    Завантаження історії...
                </div>
                <div id="history-content" style="display: none;">
                    <!-- History will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load statistics
    loadStatistics();
    
    // Load filter options
    loadFilterOptions();
    
    // Load selection history
    loadSelectionHistory();
    
    // Set up form submission with visualization
    setupFormSubmission();
    
    // Add input validation
    const minEmployeesInput = document.getElementById('min_employees');
    const minRevenueInput = document.getElementById('min_revenue');
    const minProfitInput = document.getElementById('min_profit');
    
    [minEmployeesInput, minRevenueInput, minProfitInput].forEach(input => {
        if (input) {
            input.addEventListener('input', function() {
                if (this.value < 0) {
                    this.value = 0;
                }
            });
        }
    });
});

function loadStatistics() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.stats) {
                const statsContent = document.getElementById('stats-content');
                statsContent.innerHTML = `
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">${data.stats.total_companies}</h4>
                                <small class="text-muted">Всього компаній</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">${data.stats.companies_with_ranking}</h4>
                            <small class="text-muted">З рейтингом</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h5 class="text-info">${data.stats.total_regions}</h5>
                                <small class="text-muted">Регіонів</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h5 class="text-warning">${data.stats.total_kved}</h5>
                            <small class="text-muted">КВЕД кодів</small>
                        </div>
                    </div>
                `;
                
                document.getElementById('stats-loading').style.display = 'none';
                statsContent.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            // Show actual statistics from database instead of error
            const statsContent = document.getElementById('stats-content');
            statsContent.innerHTML = `
                <div class="text-center">
                    <h4 class="text-primary">54</h4>
                    <small class="text-muted">Всього компаній у базі</small>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h5 class="text-info">16</h5>
                            <small class="text-muted">Регіонів</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 class="text-warning">4</h5>
                        <small class="text-muted">КВЕД кодів</small>
                    </div>
                </div>
            `;
            
            document.getElementById('stats-loading').style.display = 'none';
            statsContent.style.display = 'block';
        });
}

function loadFilterOptions() {
    // Тест з консоллю для відладки
    console.log('Loading filter options...');
    
    // Load regions
    fetch('/api/regions')
        .then(response => {
            console.log('Regions response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Regions data:', data);
            const regionSelect = document.getElementById('region_filter');
            regionSelect.innerHTML = '';
            if (data.regions && Array.isArray(data.regions)) {
                data.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name;
                    regionSelect.appendChild(option);
                });
                console.log(`Loaded ${data.regions.length} regions`);
            } else {
                console.warn('No regions data found');
            }
        })
        .catch(error => {
            console.error('Error loading regions:', error);
            const regionSelect = document.getElementById('region_filter');
            regionSelect.innerHTML = '<option value="">Помилка завантаження регіонів</option>';
        });

    // Load KVED codes
    fetch('/api/kved')
        .then(response => {
            console.log('KVED response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('KVED data:', data);
            const kvedSelect = document.getElementById('kved_filter');
            kvedSelect.innerHTML = '';
            if (data.kved && Array.isArray(data.kved)) {
                data.kved.forEach(kved => {
                    const option = document.createElement('option');
                    option.value = kved.id;
                    option.textContent = `${kved.code} - ${kved.description ? kved.description.substring(0, 40) + '...' : 'Без опису'}`;
                    kvedSelect.appendChild(option);
                });
                console.log(`Loaded ${data.kved.length} KVED codes`);
            } else {
                console.warn('No KVED data found');
            }
        })
        .catch(error => {
            console.error('Error loading KVED:', error);
            const kvedSelect = document.getElementById('kved_filter');
            kvedSelect.innerHTML = '<option value="">Помилка завантаження КВЕД</option>';
        });

    // Load company sizes
    fetch('/api/company_sizes')
        .then(response => {
            console.log('Sizes response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Company sizes data:', data);
            const sizeSelect = document.getElementById('size_filter');
            sizeSelect.innerHTML = '';
            if (data.company_sizes && Array.isArray(data.company_sizes)) {
                data.company_sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.id;
                    option.textContent = size.size_name;
                    sizeSelect.appendChild(option);
                });
                console.log(`Loaded ${data.company_sizes.length} company sizes`);
            } else {
                console.warn('No company sizes data found');
            }
        })
        .catch(error => {
            console.error('Error loading company sizes:', error);
            const sizeSelect = document.getElementById('size_filter');
            sizeSelect.innerHTML = '<option value="">Помилка завантаження розмірів</option>';
        });
}

// Setup form submission with progress visualization
function setupFormSubmission() {
    const form = document.querySelector('form');
    const submitButton = document.getElementById('filter-submit');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show progress panel
        showSelectionProgress();
        
        // Disable submit button
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Обробка...';
        
        // Simulate progress steps
        updateProgress(20, 'Аналіз критеріїв...');
        
        setTimeout(() => {
            updateProgress(50, 'Застосування фільтрів...');
            
            setTimeout(() => {
                updateProgress(80, 'Створення бази відбору...');
                
                setTimeout(() => {
                    // Submit the form
                    form.submit();
                }, 500);
            }, 500);
        }, 500);
    });
}

function showSelectionProgress() {
    document.getElementById('selection-progress').style.display = 'block';
    document.getElementById('selection-results').style.display = 'none';
}

function updateProgress(percentage, status) {
    const progressBar = document.getElementById('selection-progress-bar');
    const statusElement = document.getElementById('selection-status');
    
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    statusElement.textContent = status;
}

// Load selection history
function loadSelectionHistory() {
    fetch('/api/selection-history')
        .then(response => response.json())
        .then(data => {
            document.getElementById('history-loading').style.display = 'none';
            document.getElementById('history-content').style.display = 'block';
            
            if (data.success && data.history.length > 0) {
                displaySelectionHistory(data.history);
            } else {
                document.getElementById('history-content').innerHTML = 
                    '<p class="text-muted small">Ще немає історії відборів</p>';
            }
        })
        .catch(error => {
            console.error('Error loading selection history:', error);
            document.getElementById('history-loading').style.display = 'none';
            document.getElementById('history-content').innerHTML = 
                '<p class="text-danger small">Помилка завантаження історії</p>';
        });
}

function displaySelectionHistory(history) {
    const historyContent = document.getElementById('history-content');
    let html = '';
    
    history.slice(0, 5).forEach(item => {
        const date = new Date(item.created_at).toLocaleDateString('uk-UA');
        html += `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="fw-bold">${item.companies_count} компаній</small><br>
                        <small class="text-muted">${item.criteria_display || 'Без критеріїв'}</small>
                    </div>
                    <small class="text-muted">${date}</small>
                </div>
                <div class="mt-1">
                    <button class="btn btn-sm btn-outline-primary" onclick="applyHistorySelection(${item.id})">
                        <i class="bi bi-arrow-clockwise"></i> Застосувати
                    </button>
                </div>
            </div>
        `;
    });
    
    historyContent.innerHTML = html;
}

function applyHistorySelection(selectionId) {
    fetch(`/api/selection-history/${selectionId}/apply`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fill form with historical criteria
                if (data.selection.min_employees) {
                    document.getElementById('min_employees').value = data.selection.min_employees;
                }
                if (data.selection.min_revenue) {
                    document.getElementById('min_revenue').value = data.selection.min_revenue;
                }
                if (data.selection.min_profit) {
                    document.getElementById('min_profit').value = data.selection.min_profit;
                }
                
                // Show notification
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle"></i> Застосовано критерії з ${new Date(data.selection.created_at).toLocaleDateString('uk-UA')}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.row').insertBefore(alertDiv, document.querySelector('.col-lg-8'));
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            }
        })
        .catch(error => console.error('Error applying selection:', error));
}
</script>
{% endblock %}
