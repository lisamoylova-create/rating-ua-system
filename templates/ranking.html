{% extends "base.html" %}

{% block title %}Рейтинг{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-trophy"></i> Створення рейтингу компаній
            </h1>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3 id="db-total-companies">-</h3>
                    <p class="mb-0">Всього в базі</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3 id="selection-companies">-</h3>
                    <p class="mb-0">База відбору</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3 id="ranked-companies">-</h3>
                    <p class="mb-0">У рейтингу</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 id="ranking-percentage">-</h3>
                    <p class="mb-0">Покриття відбору</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Filter and Ranking Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Фільтри та параметри рейтингу</h5>
                </div>
                <div class="card-body">
                    <form id="ranking-form" method="POST">
                        <div class="row mb-3">
                            <!-- KVED Filter -->
                            <div class="col-md-4">
                                <label for="kved_filter" class="form-label">КВЕД</label>
                                <select class="form-select" id="kved_filter" name="kved_filter" multiple size="4">
                                    <option value="">Завантаження...</option>
                                </select>
                                <div class="form-text">Коди економічної діяльності</div>
                            </div>
                            
                            <!-- Region Filter -->
                            <div class="col-md-4">
                                <label for="region_filter" class="form-label">Регіон</label>
                                <select class="form-select" id="region_filter" name="region_filter" multiple size="4">
                                    <option value="">Завантаження...</option>
                                </select>
                                <div class="form-text">Фільтр за регіонами</div>
                            </div>
                            
                            <!-- Company Size Filter -->
                            <div class="col-md-4">
                                <label for="size_filter" class="form-label">Розмір компанії</label>
                                <select class="form-select" id="size_filter" name="size_filter" multiple size="4">
                                    <option value="">Завантаження...</option>
                                </select>
                                <div class="form-text">Фільтр за розмірами компаній</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <!-- Sort Criteria -->
                            <div class="col-md-4">
                                <label for="sort_criteria" class="form-label">Критерії сортування</label>
                                <select class="form-select" id="sort_criteria" name="sort_criteria" required>
                                    <option value="">Оберіть критерій</option>
                                    <option value="revenue">Чистий дохід від реалізації</option>
                                    <option value="profit">Чистий фінансовий результат</option>
                                    <option value="personnel">Кількість працівників</option>
                                </select>
                            </div>
                            
                            <!-- Sort Order -->
                            <div class="col-md-4">
                                <label for="sort_order" class="form-label">Сортування</label>
                                <select class="form-select" id="sort_order" name="sort_order">
                                    <option value="desc">За спаданням</option>
                                    <option value="asc">За зростанням</option>
                                </select>
                            </div>
                            
                            <!-- Year -->
                            <div class="col-md-4">
                                <label for="year_source" class="form-label">Рік</label>
                                <select class="form-select" id="year_source" name="year_source" required>
                                    <option value="2025" selected>2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <!-- Ranking Name -->
                            <div class="col-md-12">
                                <label for="ranking_name" class="form-label">Назва рейтингу</label>
                                <input type="text" class="form-control" id="ranking_name" name="ranking_name" 
                                       placeholder="Наприклад: Топ-100 за доходом у Київській області" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg" id="create-ranking-btn">
                                    <i class="bi bi-trophy"></i> <span id="btn-text">Створити рейтинг</span>
                                    <span id="btn-loading" class="d-none">
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        Створення рейтингу...
                                    </span>
                                </button>
                                <button type="button" id="export-csv-btn" class="btn btn-success ms-2" style="display: none;">
                                    <i class="bi bi-download"></i> Експорт у CSV
                                </button>
                                <button type="button" id="export-pdf-btn" class="btn btn-danger ms-2" style="display: none;">
                                    <i class="bi bi-file-pdf"></i> Експорт у PDF
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Інформація про базу відбору</h6>
                </div>
                <div class="card-body">
                    <div id="base-info-loading" class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Завантаження...</span>
                        </div>
                        Завантаження інформації про відбір...
                    </div>
                    <div id="base-info-content" style="display: none;">
                        <!-- Base info will be loaded here dynamically -->
                        <p class="mb-2"><strong>Поточна база відбору</strong></p>
                        <p class="text-muted small mb-1">Критерії:</p>
                        <p class="mb-3">{{ selection_criteria if selection_criteria != 'Не визначено' else 'База відбору не створена.' }}</p>
                        
                        {% if selection_info %}
                        <p class="mb-2"><strong>Деталі відбору:</strong></p>
                        <ul class="list-unstyled small text-muted mb-0">
                            <li>• Мін. працівників: {{ selection_info.min_personnel }}</li>
                            <li>• Мін. дохід: {{ selection_info.min_revenue }} грн</li>
                            <li>• Мін. прибуток: {{ selection_info.min_profit }} грн</li>
                            <li>• Регіони: {{ selection_info.regions_count }}</li>
                            <li>• КВЕД коди: {{ selection_info.kved_count }}</li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-bookmark-star"></i> Збережені рейтинги</h6>
                </div>
                <div class="card-body">
                    <div id="saved-rankings-loading" class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Завантаження...</span>
                        </div>
                        Завантаження рейтингів...
                    </div>
                    <div id="saved-rankings-content" style="display: none;">
                        <!-- Saved rankings will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="row mt-4" id="results-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Рейтинг компаній</h5>
                    <span class="badge bg-primary" id="results-count">0 компаній</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="ranking-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Місце</th>
                                    <th>Источник</th>
                                    <th>Код ЄДРПОУ</th>
                                    <th>Назва компанії</th>
                                    <th>Код КВЕД</th>
                                    <th>Назва КВЕД</th>
                                    <th>Чистий дохід (тис. грн)</th>
                                    <th>Прибуток (тис. грн)</th>
                                    <th>Персонал (осіб)</th>
                                    <th>Регіон</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-table-body">
                                <!-- Results will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
var companies = [];
var currentRanking = null;
var currentRankingId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing ranking page...');
    loadFilterOptions();
    setupEventListeners();
    loadSelectionInfo(); // This calls the correct function that loads database stats
});

// Load filter options from API
function loadFilterOptions() {
    console.log('Loading filter options...');
    
    // Load KVED codes
    fetch('/api/kved')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load KVED');
            return response.json();
        })
        .then(function(data) {
            var select = document.getElementById('kved_filter');
            select.innerHTML = '<option value="">Всі КВЕД</option>';
            
            if (data.kved && data.kved.length > 0) {
                data.kved.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.code; // Only show code, not description
                    select.appendChild(option);
                });
                console.log('Loaded', data.kved.length, 'KVED codes');
            }
        })
        .catch(function(error) {
            console.error('Error loading KVED:', error);
            document.getElementById('kved_filter').innerHTML = '<option value="">Помилка завантаження</option>';
        });
    
    // Load regions
    fetch('/api/regions')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load regions');
            return response.json();
        })
        .then(function(data) {
            var select = document.getElementById('region_filter');
            select.innerHTML = '<option value="">Всі регіони</option>';
            
            if (data.regions && data.regions.length > 0) {
                data.regions.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    select.appendChild(option);
                });
                console.log('Loaded', data.regions.length, 'regions');
            }
        })
        .catch(function(error) {
            console.error('Error loading regions:', error);
            document.getElementById('region_filter').innerHTML = '<option value="">Помилка завантаження</option>';
        });
    
    // Load company sizes
    fetch('/api/company_sizes')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load company sizes');
            return response.json();
        })
        .then(function(data) {
            var select = document.getElementById('size_filter');
            select.innerHTML = '<option value="">Всі розміри</option>';
            
            if (data.company_sizes && data.company_sizes.length > 0) {
                data.company_sizes.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.size_name;
                    select.appendChild(option);
                });
                console.log('Loaded', data.company_sizes.length, 'company sizes');
            }
        })
        .catch(function(error) {
            console.error('Error loading company sizes:', error);
            document.getElementById('size_filter').innerHTML = '<option value="">Помилка завантаження</option>';
        });
}

// Setup event listeners
function setupEventListeners() {
    console.log('Setting up event listeners...');
    try {
        // Form submission
        var formElement = document.getElementById('ranking-form');
        if (!formElement) {
            console.error('ranking-form element not found');
            return;
        }
        formElement.addEventListener('submit', function(e) {
            e.preventDefault();
            createRanking();
        });
        console.log('Form submission listener added');
        
        // Export CSV button
        var csvBtn = document.getElementById('export-csv-btn');
        if (!csvBtn) {
            console.error('export-csv-btn element not found');
        } else {
            csvBtn.addEventListener('click', function() {
                exportToCSV();
            });
            console.log('CSV export listener added');
        }
        
        // Export PDF button
        var pdfBtn = document.getElementById('export-pdf-btn');
        if (!pdfBtn) {
            console.error('export-pdf-btn element not found');
        } else {
            pdfBtn.addEventListener('click', function() {
                exportToPDF();
            });
            console.log('PDF export listener added');
        }
        
        // Filter changes for dynamic updates
        var filters = ['kved_filter', 'region_filter', 'size_filter', 'sort_criteria', 'sort_order'];
        filters.forEach(function(filterId) {
            var filterElement = document.getElementById(filterId);
            if (!filterElement) {
                console.error('Filter element not found: ' + filterId);
                return;
            }
            filterElement.addEventListener('change', function() {
                if (companies.length > 0) {
                    updateRanking();
                }
            });
        });
        console.log('Filter listeners added');
        console.log('All event listeners set up successfully');
    } catch (error) {
        console.error('Error in setupEventListeners:', error);
    }
}

// Show success message
function showSuccessMessage(message) {
    // Remove any existing success messages
    var existingMessage = document.getElementById('success-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    // Create new success message
    var messageDiv = document.createElement('div');
    messageDiv.id = 'success-message';
    messageDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
    messageDiv.innerHTML = `
        <i class="bi bi-check-circle-fill"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert after the form
    var form = document.getElementById('ranking-form');
    form.parentNode.insertBefore(messageDiv, form.nextSibling);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        if (messageDiv && messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// Show/hide loading state
function setLoadingState(isLoading) {
    var btn = document.getElementById('create-ranking-btn');
    var btnText = document.getElementById('btn-text');
    var btnLoading = document.getElementById('btn-loading');
    
    if (isLoading) {
        btn.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
    } else {
        btn.disabled = false;
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
    }
}

// Create ranking
function createRanking() {
    console.log('Creating ranking...');
    
    var formData = new FormData(document.getElementById('ranking-form'));
    var data = {
        kved_filter: Array.from(document.getElementById('kved_filter').selectedOptions).map(o => o.value),
        region_filter: Array.from(document.getElementById('region_filter').selectedOptions).map(o => o.value),
        size_filter: Array.from(document.getElementById('size_filter').selectedOptions).map(o => o.value),
        sort_criteria: formData.get('sort_criteria'),
        sort_order: formData.get('sort_order'),
        year_source: formData.get('year_source'),
        ranking_name: formData.get('ranking_name')
    };
    
    // Validate required fields
    if (!data.sort_criteria || !data.ranking_name) {
        alert('Будь ласка, заповніть всі обов\'язкові поля');
        return;
    }
    
    // Show loading state
    setLoadingState(true);
    
    // Send request to create ranking
    fetch('/ranking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(function(response) {
        console.log('Response status:', response.status, response.statusText);
        console.log('Response ok:', response.ok);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            console.error('Response not ok:', response.status, response.statusText);
            throw new Error('Server returned error: ' + response.status);
        }
        return response.text(); // Спершу отримаємо текст
    })
    .then(function(text) {
        console.log('Raw response text:', text);
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Failed to parse JSON:', e);
            console.error('Response text was:', text);
            throw new Error('Invalid JSON response from server');
        }
    })
    .then(function(result) {
        console.log('Parsed result:', result);
        if (result.success) {
            console.log('Success! Companies:', result.companies ? result.companies.length : 0);
            companies = result.companies || [];
            currentRankingId = result.ranking_id || null;
            currentRanking = {
                name: data.ranking_name,
                criteria: data.sort_criteria,
                year: data.year_source
            };
            
            try {
                console.log('Calling displayRanking...');
                displayRanking();
                console.log('displayRanking completed');
            } catch (error) {
                console.error('Error in displayRanking:', error);
            }
            
            try {
                console.log('Showing export buttons...');
                var csvBtn = document.getElementById('export-csv-btn');
                var pdfBtn = document.getElementById('export-pdf-btn');
                if (!csvBtn) {
                    console.error('export-csv-btn not found');
                } else {
                    csvBtn.style.display = 'inline-block';
                    console.log('CSV button shown');
                }
                if (!pdfBtn) {
                    console.error('export-pdf-btn not found');
                } else {
                    pdfBtn.style.display = 'inline-block';
                    console.log('PDF button shown');
                }
            } catch (error) {
                console.error('Error showing export buttons:', error);
            }
            
            try {
                console.log('Calling updateSavedRankings...');
                updateSavedRankings(data.ranking_name, companies.length, data.sort_criteria);
                console.log('updateSavedRankings completed');
            } catch (error) {
                console.error('Error in updateSavedRankings:', error);
            }
            
            try {
                console.log('Calling loadSelectionInfo...');
                loadSelectionInfo();
                console.log('loadSelectionInfo completed');
            } catch (error) {
                console.error('Error in loadSelectionInfo:', error);
            }
            
            // Hide loading state and show success message
            setLoadingState(false);
            showSuccessMessage(`Рейтинг "${data.ranking_name}" успішно створено! Проранжовано ${result.companies.length} компаній.`);
        } else {
            console.error('Server returned error:', result.error);
            setLoadingState(false);
            alert('Помилка: ' + (result.error || 'Не вдалося створити рейтинг'));
        }
    })
    .catch(function(error) {
        console.error('Error creating ranking:', error);
        setLoadingState(false);
        alert('Помилка при створенні рейтингу: ' + error.message);
    });
}

// Update ranking when filters change
function updateRanking() {
    if (!companies.length) return;
    
    var kvedFilter = Array.from(document.getElementById('kved_filter').selectedOptions).map(o => o.value);
    var regionFilter = Array.from(document.getElementById('region_filter').selectedOptions).map(o => o.value);
    var sizeFilter = Array.from(document.getElementById('size_filter').selectedOptions).map(o => o.value);
    var sortCriteria = document.getElementById('sort_criteria').value;
    var sortOrder = document.getElementById('sort_order').value;
    
    // Filter companies
    var filtered = companies.filter(function(company) {
        var matchesKved = !kvedFilter.length || kvedFilter.includes('') || kvedFilter.includes(company.kved_code);
        var matchesRegion = !regionFilter.length || regionFilter.includes('') || regionFilter.includes(company.region_name);
        var matchesSize = !sizeFilter.length || sizeFilter.includes('') || sizeFilter.includes(company.company_size_name);
        
        return matchesKved && matchesRegion && matchesSize;
    });
    
    // Sort companies
    if (sortCriteria) {
        filtered.sort(function(a, b) {
            var aVal = getSortValue(a, sortCriteria);
            var bVal = getSortValue(b, sortCriteria);
            
            if (sortOrder === 'asc') {
                return aVal - bVal; // Ascending order
            } else {
                return bVal - aVal; // Descending order (default)
            }
        });
    }
    
    // Assign rankings
    filtered.forEach(function(company, index) {
        company.ranking = index + 1;
    });
    
    displayRankingTable(filtered);
}

// Get sort value for company
function getSortValue(company, criteria) {
    switch(criteria) {
        case 'revenue': return company.revenue_2019 || 0;
        case 'profit': return company.profit_2019 || 0;
        case 'personnel': return company.personnel_2019 || 0;
        default: return 0;
    }
}

// Display ranking
function displayRanking() {
    updateRanking();
    document.getElementById('results-section').style.display = 'block';
}

// Display ranking table
function displayRankingTable(companies) {
    var tbody = document.getElementById('ranking-table-body');
    tbody.innerHTML = '';
    
    companies.forEach(function(company) {
        var row = document.createElement('tr');
        row.innerHTML = 
            '<td><strong>' + company.ranking + '</strong></td>' +
            '<td><small>' + (company.source || '-') + '</small></td>' +
            '<td>' + (company.edrpou || '-') + '</td>' +
            '<td>' + (company.company_name || '-') + '</td>' +
            '<td>' + (company.kved_code || '-') + '</td>' +
            '<td>' + (company.kved_description || '-') + '</td>' +
            '<td>' + formatNumber(company.revenue_2019) + '</td>' +
            '<td>' + formatNumber(company.profit_2019) + '</td>' +
            '<td>' + formatNumber(company.personnel_2019) + '</td>' +
            '<td><span class="badge bg-secondary">' + (company.region_name || '-') + '</span></td>';
        tbody.appendChild(row);
    });
    
    document.getElementById('results-count').textContent = companies.length + ' компаній';
}

// Format number for display
function formatNumber(value) {
    if (!value || value === 0) return '-';
    return new Intl.NumberFormat('uk-UA').format(value);
}

// Export to CSV with all fields
function exportToCSV() {
    if (!companies.length) {
        alert('Немає даних для експорту');
        return;
    }
    
    console.log('First company data:', companies[0]);
    console.log('All company fields:', Object.keys(companies[0]));
    
    // CSV header with all fields (25 total)
    var csv = 'Місце в рейтингу,Источник,Код ЄДРПОУ,Назва компанії,Код КВЕД,Назва КВЕД,Персонал (осіб),Регіон,Телефон,Адреса,Чистий дохід (тис. грн),Прибуток (тис. грн),Розмір компанії,Ім\'я керівника,По батькові,Прізвище,Робочий телефон,Корпоративний сайт,Робоча пошта,Статус компанії,Директор,Держзакупівлі (тис. грн),Кількість тендерів,Ініціали,Актуалізовано\n';
    
    companies.forEach(function(company) {
        csv += [
            company.ranking || '-',
            '"' + (company.source || '-') + '"',
            '"' + (company.edrpou || '-') + '"',
            '"' + (company.company_name || '-').replace(/"/g, '""') + '"',
            '"' + (company.kved_code || '-') + '"',
            '"' + (company.kved_description || '-').replace(/"/g, '""') + '"',
            company.personnel_2019 || 0,
            '"' + (company.region_name || '-') + '"',
            '"' + (company.phone || '-') + '"',
            '"' + (company.address || '-').replace(/"/g, '""') + '"',
            company.revenue_2019 || 0,
            company.profit_2019 || 0,
            '"' + (company.company_size_name || '-') + '"',
            '"' + (company.first_name || '-') + '"',
            '"' + (company.middle_name || '-') + '"',
            '"' + (company.last_name || '-') + '"',
            '"' + (company.work_phone || '-') + '"',
            '"' + (company.corporate_site || '-') + '"',
            '"' + (company.work_email || '-') + '"',
            '"' + (company.company_status || '-') + '"',
            '"' + (company.director || '-').replace(/"/g, '""') + '"',
            company.government_purchases || 0,
            company.tender_count || 0,
            '"' + (company.initials || '-') + '"',
            '"' + (company.actualized || '-') + '"'
        ].join(',') + '\n';
    });
    
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', (currentRanking ? currentRanking.name : 'ranking') + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Export to PDF
function exportToPDF() {
    if (!currentRankingId) {
        alert('Спочатку створіть рейтинг');
        return;
    }
    
    // Відкриваємо PDF експорт у новій вкладці
    window.open('/ranking/' + currentRankingId + '/export-pdf', '_blank');
}

// Load database statistics from server (real-time)
function loadSelectionInfo() {
    console.log('Loading database statistics...');
    
    // Fetch current selection info from server
    fetch('/api/current-selection-info')
        .then(function(response) {
            if (!response.ok) {
                console.warn('Failed to load current selection info, using template data');
                // Fallback to template data
                var stats = {
                    total_in_database: {{ total_companies|default(0) }},
                    total_in_selection: {{ selection_count|default(0) }},
                    companies_with_ranking: {{ ranked_companies|default(0) }},
                    selection_criteria: '{{ selection_criteria|default("Не визначено") }}'
                };
                displayDatabaseStats(stats);
                return;
            }
            return response.json();
        })
        .then(function(data) {
            if (data && data.success) {
                console.log('Loaded current selection info:', data);
                displayDatabaseStats(data);
            }
        })
        .catch(function(error) {
            console.error('Error loading selection info:', error);
            // Fallback to template data
            var stats = {
                total_in_database: {{ total_companies|default(0) }},
                total_in_selection: {{ selection_count|default(0) }},
                companies_with_ranking: {{ ranked_companies|default(0) }},
                selection_criteria: '{{ selection_criteria|default("Не визначено") }}'
            };
            displayDatabaseStats(stats);
        });
}

// This function is now handled by the updated displayDatabaseStats above

// Display legacy stats format
function displayLegacyStats(info) {
    document.getElementById('db-total-companies').innerHTML = 'Завантаження...';
    document.getElementById('selection-companies').innerHTML = formatNumber(info.total_companies || 0);
    document.getElementById('ranked-companies').innerHTML = '0';
    document.getElementById('ranking-percentage').innerHTML = '0%';
}

// Display default stats when no data available
function displayDefaultStats() {
    document.getElementById('db-total-companies').innerHTML = formatNumber({{ total_companies|default(0) }});
    document.getElementById('selection-companies').innerHTML = formatNumber({{ selection_count|default(0) }});
    document.getElementById('ranked-companies').innerHTML = formatNumber({{ ranked_companies|default(0) }});
    
    var percentage = 0;
    {% if selection_count and ranked_companies and selection_count > 0 %}
    percentage = Math.round(({{ ranked_companies }} / {{ selection_count }}) * 100);
    {% endif %}
    document.getElementById('ranking-percentage').innerHTML = percentage + '%';
}

// Show default base info
function showDefaultBaseInfo() {
    try {
        var loadingElement = document.getElementById('base-info-loading');
        var contentElement = document.getElementById('base-info-content');
        
        if (!loadingElement || !contentElement) {
            console.error('Base info elements not found in showDefaultBaseInfo');
            return;
        }
        
        loadingElement.style.display = 'none';
        contentElement.style.display = 'block';
        contentElement.innerHTML = `
            <h6 class="text-warning">База відбору</h6>
            <p class="mb-1"><small class="text-muted">Статус:</small></p>
            <div class="text-muted small">
                <i class="bi bi-info-circle"></i> Створіть базу відбору у розділі "Відбір компаній для рейтингу"
            </div>
        `;
        console.log('Default base info shown successfully');
    } catch (error) {
        console.error('Error in showDefaultBaseInfo:', error);
    }
}

// Show default rankings info  
function showDefaultRankingsInfo() {
    try {
        var loadingElement = document.getElementById('saved-rankings-loading');
        var contentElement = document.getElementById('saved-rankings-content');
        
        if (!loadingElement || !contentElement) {
            console.error('Saved rankings elements not found');
            return;
        }
        
        loadingElement.style.display = 'none';
        contentElement.style.display = 'block';
        contentElement.innerHTML = `
            <h6 class="text-muted">Збережені рейтинги</h6>
            <p class="mb-1"><small class="text-muted">Ще не створено</small></p>
            <div class="text-muted small">
                <i class="bi bi-bookmark"></i> Тут відображатимуться створені рейтинги
            </div>
        `;
        console.log('Default rankings info shown successfully');
    } catch (error) {
        console.error('Error in showDefaultRankingsInfo:', error);
    }
}

// Update the displayDatabaseStats function to work with our cards
function displayDatabaseStats(stats) {
    try {
        // Total companies in database
        var dbTotalElement = document.getElementById('db-total-companies');
        if (!dbTotalElement) {
            console.error('Element db-total-companies not found');
            return;
        }
        dbTotalElement.textContent = formatNumber(stats.total_in_database || 0);
        
        // Companies in current selection
        var selectionElement = document.getElementById('selection-companies');
        if (!selectionElement) {
            console.error('Element selection-companies not found');
            return;
        }
        selectionElement.textContent = formatNumber(stats.total_in_selection || 0);
        
        // Companies with ranking
        var rankedElement = document.getElementById('ranked-companies');
        if (!rankedElement) {
            console.error('Element ranked-companies not found');
            return;
        }
        rankedElement.textContent = formatNumber(stats.companies_with_ranking || 0);
        
        // Calculate percentage
        var percentage = 0;
        if (stats.total_in_selection > 0 && stats.companies_with_ranking > 0) {
            percentage = Math.round((stats.companies_with_ranking / stats.total_in_selection) * 100);
        }
        var percentageElement = document.getElementById('ranking-percentage');
        if (!percentageElement) {
            console.error('Element ranking-percentage not found');
            return;
        }
        percentageElement.textContent = percentage + '%';
        
        console.log('Statistics updated successfully');
    } catch (error) {
        console.error('Error in displayDatabaseStats:', error);
    }
    
    // Update base info if selection criteria available
    if (stats.selection_criteria && stats.selection_criteria !== 'Критерії не задано') {
        updateBaseInfo(stats);
    } else {
        showDefaultBaseInfo();
    }
}

// Update base info with real criteria
function updateBaseInfo(selectionInfo) {
    try {
        var loadingElement = document.getElementById('base-info-loading');
        var contentElement = document.getElementById('base-info-content');
        
        if (!loadingElement || !contentElement) {
            console.error('Base info elements not found');
            return;
        }
        
        loadingElement.style.display = 'none';
        contentElement.style.display = 'block';
        
        var html = `
            <h6 class="text-primary">Поточна база відбору</h6>
            <p class="mb-1"><small class="text-muted">Критерії:</small></p>
            <div class="alert alert-info py-2">
                <small>${selectionInfo.selection_criteria}</small>
            </div>
        `;
        
        if (selectionInfo.selection_info && selectionInfo.selection_info.companies_count > 0) {
            html += `
                <p class="mb-2"><strong>Деталі відбору:</strong></p>
                <ul class="list-unstyled small text-muted mb-0">
                    <li>• Компаній у відборі: ${selectionInfo.total_in_selection}</li>
                    <li>• Мін. працівників: ${selectionInfo.selection_info.min_personnel || 'Не задано'}</li>
                    <li>• Мін. дохід: ${selectionInfo.selection_info.min_revenue || 'Не задано'}</li>
                    <li>• Мін. прибуток: ${selectionInfo.selection_info.min_profit || 'Не задано'}</li>
                </ul>
            `;
        }
        
        html += `
            <div class="text-success small mt-2">
                <i class="bi bi-check-circle"></i> База відбору активна
            </div>
        `;
        
        contentElement.innerHTML = html;
        console.log('Base info updated successfully');
    } catch (error) {
        console.error('Error in updateBaseInfo:', error);
    }
}

// Update saved rankings info
function updateSavedRankings(rankingName, count, criteria) {
    try {
        var loadingElement = document.getElementById('saved-rankings-loading');
        var contentElement = document.getElementById('saved-rankings-content');
        
        if (!loadingElement) {
            console.error('saved-rankings-loading element not found');
            return;
        }
        if (!contentElement) {
            console.error('saved-rankings-content element not found');
            return;
        }
        
        loadingElement.style.display = 'none';
        contentElement.style.display = 'block';
        contentElement.innerHTML = `
            <h6 class="text-success">Останній рейтинг</h6>
            <div class="alert alert-success py-2">
                <strong>${rankingName}</strong><br>
                <small class="text-dark">${count} компаній за критерієм "${criteria}"</small>
            </div>
            <div class="text-success small">
                <i class="bi bi-bookmark-check"></i> Рейтинг збережено
            </div>
        `;
        console.log('updateSavedRankings: Updated successfully');
    } catch (error) {
        console.error('Error in updateSavedRankings:', error);
    }
}

</script>
{% endblock %}