{% extends "base.html" %}

{% block title %}Завантаження в базу даних{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-database-fill-add"></i> Завантаження в базу даних: {{ filename }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             role="progressbar" style="width: 0%" id="progressBar">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card bg-primary bg-opacity-25 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="text-primary" id="processedCount">0</h5>
                                    <small class="text-light">Оброблено</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning bg-opacity-25 border-warning">
                                <div class="card-body text-center">
                                    <h5 class="text-warning" id="updatedCount">0</h5>
                                    <small class="text-light">Оновлено</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success bg-opacity-25 border-success">
                                <div class="card-body text-center">
                                    <h5 class="text-success" id="insertedCount">0</h5>
                                    <small class="text-light">Додано</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger bg-opacity-25 border-danger">
                                <div class="card-body text-center">
                                    <h5 class="text-danger" id="errorCount">0</h5>
                                    <small class="text-light">Помилки</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i> Підготовка до завантаження...
                    </div>
                    
                    <div id="logContainer" class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: var(--bs-dark); color: var(--bs-light);">
                        <div class="text-light mb-2">
                            <i class="bi bi-terminal"></i> Лог завантаження:
                        </div>
                        <div id="logMessages"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" id="stopBtn" onclick="stopImport()" style="display:none;">
                            <i class="bi bi-stop-fill"></i> Зупинити
                        </button>
                        <a href="{{ url_for('main.file_manager') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Назад до файлів
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3" id="resultsCard" style="display:none;">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-check-circle-fill"></i> Завантаження завершено
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Всього записів:</strong> <span id="totalRecords">0</span></p>
                            <p><strong>Успішно оброблено:</strong> <span id="finalProcessed">0</span></p>
                            <p><strong>Оновлено:</strong> <span id="finalUpdated">0</span></p>
                            <p><strong>Додано нових:</strong> <span id="finalInserted">0</span></p>
                            <p><strong>Помилок:</strong> <span id="finalErrors">0</span></p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('main.companies') }}" class="btn btn-success">
                                    <i class="bi bi-list-ul"></i> Переглянути компанії
                                </a>
                                <a href="{{ url_for('main.file_manager') }}" class="btn btn-outline-primary">
                                    <i class="bi bi-folder2-open"></i> Менеджер файлів
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let importRunning = false;
let pollInterval = null;

function addLogMessage(message, type = 'info') {
    const logContainer = document.getElementById('logMessages');
    const timestamp = new Date().toLocaleTimeString();
    const iconClass = type === 'error' ? 'bi-exclamation-triangle-fill text-danger' : 
                     type === 'success' ? 'bi-check-circle-fill text-success' : 
                     type === 'warning' ? 'bi-exclamation-circle-fill text-warning' :
                     'bi-info-circle-fill text-info';
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-1 small';
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> <i class="bi ${iconClass}"></i> ${message}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function updateProgress(processed, total, updated, inserted, errors) {
    const percentage = total > 0 ? Math.round((processed / total) * 100) : 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const processedCount = document.getElementById('processedCount');
    const updatedCount = document.getElementById('updatedCount');
    const insertedCount = document.getElementById('insertedCount');
    const errorCount = document.getElementById('errorCount');
    
    if (progressBar) progressBar.style.width = percentage + '%';
    if (progressText) progressText.textContent = percentage + '%';
    if (processedCount) processedCount.textContent = processed;
    if (updatedCount) updatedCount.textContent = updated;
    if (insertedCount) insertedCount.textContent = inserted;
    if (errorCount) errorCount.textContent = errors;
}

function updateStatus(message, type = 'info') {
    const statusEl = document.getElementById('statusMessage');
    if (statusEl) {
        statusEl.className = `alert alert-${type}`;
        statusEl.innerHTML = `<i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}-fill"></i> ${message}`;
    }
}

function startImport() {
    importRunning = true;
    document.getElementById('stopBtn').style.display = 'inline-block';
    updateStatus('Запуск завантаження в базу даних...', 'info');
    addLogMessage('Початок завантаження файлу {{ filename }} в базу даних', 'info');
    
    // Start the import process
    fetch('/api/start-database-import/{{ filename }}', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addLogMessage('Завантаження розпочато успішно', 'success');
            pollProgress();
        } else {
            addLogMessage('Помилка запуску: ' + data.error, 'error');
            updateStatus('Помилка запуску завантаження', 'danger');
        }
    })
    .catch(error => {
        addLogMessage('Помилка запиту: ' + error.message, 'error');
        updateStatus('Помилка мережі', 'danger');
    });
}

function pollProgress() {
    if (!importRunning) return;
    
    fetch('/api/database-import-status/{{ filename }}')
    .then(response => response.json())
    .then(data => {
        if (data.running) {
            updateProgress(data.processed, data.total, data.updated, data.inserted, data.errors);
            updateStatus(`Обробка... ${data.processed}/${data.total} записів`, 'info');
            
            if (data.message) {
                addLogMessage(data.message, 'info');
            }
            
            // Continue polling
            setTimeout(pollProgress, 2000);
        } else {
            // Import finished
            importRunning = false;
            document.getElementById('stopBtn').style.display = 'none';
            
            if (data.success) {
                updateProgress(data.processed, data.total, data.updated, data.inserted, data.errors);
                updateStatus('Завантаження завершено успішно!', 'success');
                addLogMessage(`Завершено: ${data.processed} записів, оновлено: ${data.updated}, додано: ${data.inserted}, помилок: ${data.errors}`, 'success');
                showResults(data.total, data.processed, data.updated, data.inserted, data.errors);
            } else {
                updateStatus('Завантаження завершено з помилками', 'warning');
                addLogMessage('Помилка завантаження: ' + (data.error || 'Невідома помилка'), 'error');
            }
        }
    })
    .catch(error => {
        addLogMessage('Помилка перевірки статусу: ' + error.message, 'error');
        setTimeout(pollProgress, 5000); // Retry after 5 seconds
    });
}

function stopImport() {
    importRunning = false;
    updateStatus('Зупинка завантаження...', 'warning');
    addLogMessage('Завантаження зупинено користувачем', 'warning');
    document.getElementById('stopBtn').style.display = 'none';
}

function showResults(total, processed, updated, inserted, errors) {
    document.getElementById('totalRecords').textContent = total;
    document.getElementById('finalProcessed').textContent = processed;
    document.getElementById('finalUpdated').textContent = updated;
    document.getElementById('finalInserted').textContent = inserted;
    document.getElementById('finalErrors').textContent = errors;
    document.getElementById('resultsCard').style.display = 'block';
}

// Start import when page loads
document.addEventListener('DOMContentLoaded', function() {
    addLogMessage('Сторінка завантажена, починаємо імпорт', 'info');
    setTimeout(startImport, 1000);
});
</script>
{% endblock %}